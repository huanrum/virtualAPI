<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body {
            position: relative;
        }

        .text-align-center {
            text-align: center;
        }

        .helper {
            color: #ac5600;
            cursor: pointer;
            font-weight: 700;
        }

        .config-group {
            margin: 1em;
        }

        .config-group legend:hover {
            cursor: pointer;
            color: #99ff99;
        }

        .config-item {
            margin: 1em;
        }

        .config-item .config-url>* {
            display: inline-block;
            min-width: 6em;
            font-weight: bold;
        }

        .config-item .config-url:hover {
            cursor: pointer;
            opacity: 0.6;
        }

        .config-item .config-return {
            margin: 0.5em 0 0 6em;
            min-height: 6em;
            width: calc(100% - 8em);
            background: #d3d3d3;
        }
        /*dialog*/

        .common-dialog-back {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(123, 123, 123, 0.6);
        }

        .common-dialog-Message {
            position: absolute;
            margin-left: 80%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 2px;
            border-radius: 10px;
            background: #669966;
        }

        .common-dialog-back .common-dialog {
            position: absolute;
            margin-left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 2px;
            border-radius: 10px;
            background: #f3f3f3;
        }

        .common-dialog-back .common-dialog.max-window {
            width: 96%;
            height: 96%;
            left: 2%!important;
            top: 2%!important;
            margin-left: 0;
            transform: none;
        }

        .common-dialog-back .common-dialog .common-dialog-header {
            height: 2em;
            background: #666699;
            padding: 0.5em;
        }

        .common-dialog-back .common-dialog .common-dialog-header label {
            color: #ffffff;
        }

        .common-dialog-back .common-dialog .common-dialog-header label sup {
            color: rgba(168, 168, 168, 0.4);
        }

        .common-dialog-back .common-dialog .common-dialog-header a {
            float: right;
            cursor: pointer;
        }

        .common-dialog-back .common-dialog .common-dialog-content {
            max-height: 33em;
            min-width: 12em;
        }

        .common-dialog-back .common-dialog .common-dialog-content>* {
            margin: 0.3em;
        }

        .common-dialog-back .common-dialog .common-dialog-content div div {
            display: inline-block;
            width: 12em;
        }

        .common-dialog-back .common-dialog .common-dialog-content div input {
            background: #f3f3f3;
            border: none;
            border-bottom: 1px solid #666699;
        }

        .common-dialog-back .common-dialog .common-dialog-message {
            width: calc(100% - 1rem);
            height: 100%;
            background: #d3d3d3;
            margin: 0.5em;
            max-height: 33em;
            min-height: 10em;
            overflow: auto;
        }

        .common-dialog-back .common-dialog .common-dialog-footer {
            border-top: 1px solid #d3d3d3;
            text-align: center;
            padding: 2px;
        }

        .common-dialog-back .common-dialog .common-dialog-footer a {
            border: 1px solid #666699;
            margin: 2px 1em;
            padding: 1px;
            cursor: pointer;
        }

        .common-dialog-back .common-dialog .common-dialog-footer a:hover {
            opacity: 0.8;
            color: #f3f3f3;
        }
    </style>
</head>

<body>
    <script>
        window.configData = [];
    </script>
    <script>
        var methodColor = {
            GET: '#337733',
            POST: '#CCCC66',
            PUT: '#66CCCC',
            DELETE: '#FF3333'
        };

        var header = document.createElement('div');
        var info = document.createElement('span');
        var helper = document.createElement('span');
        var webSocket = document.createElement('span');
        var panel = document.createElement('div');
        header.className = 'text-align-center';
        header.appendChild(info);
        header.appendChild(webSocket);
        header.appendChild(helper);
        document.body.appendChild(header);
        document.body.appendChild(panel);
        helper.innerHTML = ' - <a class="helper">帮助</a>';
        webSocket.innerHTML = ' - <a class="helper">WebSocket</a>';
        info.innerHTML = ' URL里面参数越靠后优先级越高,点击API的<strong>Method</strong>可以进行测试,点击<strong>URL</strong>可以打开和关闭返回数据结构。';
        window.configData.forEach(function (item) {
            panel.appendChild(createGroup(item));
        });
        info.onclick = function () {
            var close = Array.prototype.some.call(panel.children, function (fieldset) {
                return fieldset.lastChild.style.display === 'none';
            });
            Array.prototype.forEach.call(panel.children, function (fieldset) {
                fieldset.lastChild.style.display = close ? 'block' : 'none';
            })
        };
        helper.onclick = function () {
            window.open('document/help.html');
        };

        webSocket.onclick = function () {
            window.open('document/websocket.html');
        };

        function createGroup(item) {
            var fieldset = document.createElement('fieldset');
            var legend = document.createElement('legend');
            var content = document.createElement('div');
            var charCount = 0;
            Array.prototype.forEach.call('' + item.file.split('/')[1], function (i) {
                charCount = charCount + i.charCodeAt();
            });
            fieldset.className = 'config-group';
            legend.innerHTML = item.file;
            legend.style.color = '#' + new Date(10000).setYear(charCount).toString(16).slice(-8, -2);
            Object.keys(item.config).forEach(function (key) {
                content.appendChild(createItem(key.match(/^\[(.*)\]/), key, item.config[key], item.file === 'config/base.json'));
            });
            if (!Object.keys(item.config).length) {
                legend.style.textDecoration = 'line-through';
            }
            fieldset.appendChild(legend);
            fieldset.appendChild(content);
            legend.onclick = function () {
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            };
            if (item.file === 'config/base.json') {
                content.style.display = 'none';
                legend.innerHTML = item.file + ' <i>[Test]</i>';
            }
            return fieldset;
        }

        function createItem(methodData, urlData, returnData, isTest) {
            var isDisable = isTest ? false : null;
            var parent = document.createElement('div');
            var urlElement = document.createElement('div');
            var returnElement = document.createElement('textarea');

            var method = document.createElement('div');
            var url = document.createElement('div');

            parent.className = 'config-item';
            urlElement.className = 'config-url';
            returnElement.className = 'config-return';

            method.innerHTML = (methodData && methodData[1] || 'GET').toLocaleUpperCase();
            method.style.color = methodColor[method.innerHTML];

            url.innerHTML = urlData.split('?')[0].replace(/^\[.*\]/, '');
            returnElement.style.display = 'none';
            returnElement.readOnly = true;
            returnElement.value = linefeed(JSON.stringify(returnData,null,4));

            urlElement.appendChild(method);
            urlElement.appendChild(url);
            parent.appendChild(urlElement);
            parent.appendChild(returnElement);


            url.onclick = function () {
                returnElement.style.display = returnElement.style.display === 'none' ? 'block' : 'none';
            };
            method.onclick = function () {
                var default_data = {};
                if (urlData.split('?')[1]) {
                    urlData.split('?')[1].split('&').forEach(function (kv) {
                        default_data[kv.split('=')[0]] = kv.split('=')[1];
                    });
                }
                urlElement.style.color = '#6666ff';
                showDialog(isDisable, method.innerHTML, url.innerHTML, JSON.stringify(returnData), default_data, function (disable) {
                    if (disable === undefined) {
                        urlElement.style.color = null;
                    } else {
                        isDisable = disable;
                        urlElement.style.opacity = disable ? '0.2' : '1.0';
                    }
                });
            };

            return parent;
        }

        function linefeed(str) {
            return str;
            var live = 0, line = false;
            var br = function () { return line ? '' : '<br>'; }
            for (var i = 0; i < str.length; i++) {
                if (str[i] === '"' && str[i - 1] !== '\\') {
                    line = !line;
                }
                switch (str[i]) {
                    case '[':
                        live = live + 1;
                        break;
                    case ']':
                        live = live - 1;
                        break;
                    case '{':
                        live = live + 1;
                        if (',;[]'.indexOf(str[i - 1]) === -1) {
                            str = str.slice(0, i + 1) + br() + Array(live + 1).join('    ') + str.slice(i + 1);
                            i = i + live * 4 + 4;
                        } else {
                            str = str.slice(0, i) + br() + Array(live).join('    ') + str[i] + br() + Array(live + 1).join('    ') + str.slice(i + 1);
                            i = i + live * 4 + live * 4 + 4;
                        }
                        break;
                    case '}':
                        live = live - 1;
                        if (',;[]'.indexOf(str[i + 1]) === -1) {//下一个不是这些符号
                            str = str.slice(0, i) + br() + Array(live + 1).join('    ') + '}' + Array(live + 1).join('    ') + str.slice(i + 1);
                            i = i + live * 4 + live * 4 + 4;
                        } else {
                            if (',;'.indexOf(str[i + 1]) === -1) {//下一个不是这些符号
                                str = str.slice(0, i) + br() + Array(live + 1).join('    ') + '}' + br() + Array(live).join('    ') + str.slice(i + 1);
                                i = i + live * 4 + live * 4;
                            } else {
                                str = str.slice(0, i) + br() + Array(live + 1).join('    ') + '}' + str.slice(i + 1);
                                i = i + live * 4 + 4;
                            }
                        }
                        break;
                    case ',':
                        if (str[i + 1] === '"') {
                            str = str.slice(0, i + 1) + br() + Array(live + 1).join('    ') + str.slice(i + 1);
                            i = i + live * 4 + 4;
                        }
                        break;
                    case ';':
                        str = str.slice(0, i + 1) + br() + Array(live + 1).join('    ') + str.slice(i + 1);
                        i = i + live * 4 + 4;
                        break;
                }
            }
            return str.replace(/\s/g, '&nbsp;&nbsp;');
        }


        function showDialog(isDisable, methodData, urlData, returnData, default_data, callback) {
            var dialogPanl = document.createElement('div');
            var dialog = document.createElement('div');

            var header = document.createElement('div');
            var content = document.createElement('div');
            var message = document.createElement('textarea');
            var footer = document.createElement('div');

            initHeader();
            initFooter(initContent());
            message.readOnly = true;

            document.body.onkeyup = function (e) {
                if (e.keyCode === 27) {
                    dialogPanl.parentNode.removeChild(dialogPanl);
                }
            };

            dialogPanl.className = 'common-dialog-back';
            dialog.className = 'common-dialog';
            header.className = 'common-dialog-header';
            content.className = 'common-dialog-content';
            message.className = 'common-dialog-message';
            footer.className = 'common-dialog-footer';
            dialogPanl.appendChild(dialog);
            dialog.appendChild(header);
            dialog.appendChild(content);
            dialog.appendChild(message);
            dialog.appendChild(footer);

            message.style.maxWidth = document.body.offsetWidth * 2 / 3 + 'px';
            document.body.appendChild(dialogPanl);
            drag(header, dialog);

            function initHeader() {
                var title = document.createElement('label');
                var close = document.createElement('a');
                title.innerHTML = urlData;
                close.innerHTML = '&times;';
                header.appendChild(title);
                header.appendChild(close);
                header.ondblclick = function () {
                    if (/max-window/.test(dialog.className)) {
                        dialog.className = dialog.className.replace(/\smax-window/, '');
                        message.style.maxWidth = document.body.offsetWidth * 2 / 3 + 'px';
                        message.style.maxHeight = '';
                    } else {
                        dialog.className = dialog.className + ' max-window';
                        message.style.maxWidth = 'none';
                        message.style.maxHeight = dialog.offsetHeight - header.offsetHeight - content.offsetHeight - footer.offsetHeight - 45 + 'px';
                    }
                };
                close.onclick = function () {
                    dialogPanl.parentNode.removeChild(dialogPanl);
                    callback();
                };
            }
            function initContent() {
                var el_data = {};
                match(urlData, false);
                match(returnData, true);
                return el_data;

                function match(str, enumerable) {
                    var parms = str.match(/:[0-9a-zA-Z_]+/g);
                    if (parms) {
                        parms.forEach(function (key) {
                            if (/:(null|false|true|undefined|\d+)/.test(key)) {
                                return;
                            }
                            if (typeof el_data[key.replace(':', '')] === 'undefined' && !/:\d+/.test(key)) {
                                Object.defineProperty(el_data, key.replace(':', ''), {
                                    enumerable: enumerable,
                                    get: initRow(key, default_data[key.replace(':', '')], enumerable)
                                });
                            }
                        });
                    }
                }

                function initRow(key, dafaultValue, nullable) {
                    var row = document.createElement('div');
                    var label = document.createElement('div');
                    var value = document.createElement('input');
                    label.innerHTML = key.replace(':', '') + (nullable ? '' : '*');
                    value.value = dafaultValue || '';
                    row.appendChild(label);
                    row.appendChild(value);
                    content.appendChild(row);
                    setTimeout(function () {
                        value.focus();
                    }, 200);
                    return function () {
                        return value.value;
                    };
                }
            }


            function initFooter(el_data) {
                var disable = document.createElement('a');
                var copy = document.createElement('a');
                var confrom = document.createElement('a');

                footer.appendChild(confrom);
                if (typeof isDisable === 'boolean') {
                    footer.appendChild(disable);
                }

                footer.appendChild(copy);

                disable.innerHTML = isDisable ? 'Enable' : 'Disable';
                copy.innerHTML = 'Copy';
                confrom.innerHTML = methodData;

                copy.style.opacity = isDisable ? 0.2 : 1.0;
                confrom.style.opacity = isDisable ? 0.2 : 1.0;

                disable.onclick = function () {
                    http(urlData.split('/').map(function (i) { return /:/.test(i) && el_data[i.replace(':', '')] || i; }).join('/'), { disable: !isDisable }).then(function (req) {
                        if (req.status === 200) {
                            return req.json();
                        }
                        return req.text();
                    }).then(function () {
                        isDisable = !isDisable;
                        disable.innerHTML = isDisable ? 'Enable' : 'Disable';
                        copy.style.opacity = isDisable ? 0.2 : 1.0;
                        confrom.style.opacity = isDisable ? 0.2 : 1.0;
                        if (isDisable) {
                            message.innerHTML = '此API不可用！';
                        } else {
                            setTimeout(function () {
                                confrom.click();
                            }, 100);
                        }
                        callback(isDisable);
                    });
                };

                confrom.onclick = function () {
                    if (isDisable) {
                        message.innerHTML = '此API不可用！';
                        return;
                    }
                    http(urlData.split('/').map(function (i) { return /:/.test(i) && el_data[i.replace(':', '')] || i; }).join('/')).then(function (req) {
                        if (req.status === 200) {
                            return req.json();
                        }
                        return req.text();
                    }).then(function (req) {
                        message.value = linefeed(JSON.stringify(req,null,4));
                    });
                };

                copy.onclick = function (item) {
                    if (isDisable) { return; }
                    var textarea = document.createElement("textarea");
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = 0.01;
                    document.body.appendChild(textarea);
                    textarea.value = message.innerText.replace(/[0-9a-zA-Z_\"]\s+[0-9a-zA-Z_\"]/g, function (str1) {
                        return str1[0] + ' ' + str1[str1.length - 1];
                    });
                    textarea.select(); // 选择对象 
                    Array(10).forEach(function (v, i) {
                        setTimeout(function () {
                            document.execCommand("Copy", 'false', null);
                        }, 10 * i);
                    });
                    setTimeout(function () {
                        document.execCommand("Copy", 'false', null);
                        showMessage('已经复制了数据');
                        document.body.removeChild(textarea);
                    }, 200);
                }

                setTimeout(function () {
                    confrom.click();
                }, 100);

                function http(urlFull, headers) {
                    if (/:/.test(urlFull)) {
                        message.innerHTML = "必填参数没有填写";
                    } else {
                        if (methodData === 'GET' || methodData === 'HEADER') {
                            var urlParm = Object.keys(el_data).map(function (key) {
                                return key + '=' + encodeURIComponent(el_data[key]);
                            }).join('&');
                            return fetch(urlFull + (urlParm ? ('?' + urlParm) : ''), {
                                method: methodData,
                                headers: headers
                            });
                        } else {
                            return fetch(urlFull, {
                                method: methodData,
                                headers: headers,
                                body: JSON.stringify(el_data)
                            });
                        }
                    }
                }
            }

            function showMessage(message, time) {
                time = time || 10;
                var dialog = document.createElement('div');
                dialog.className = 'common-dialog-Message';
                dialog.innerHTML = message;
                dialog.style.opacity = 1;
                document.body.appendChild(dialog);
                var handel = setInterval(function () {
                    dialog.style.opacity = dialog.style.opacity - (1 / time);
                    if (dialog.style.opacity < 0) {
                        document.body.removeChild(dialog);
                        clearInterval(handel);
                    }
                }, 1000);
            }


            function drag(canDragElement, element) {
                var temp = {};
                canDragElement.addEventListener('mousedown', function (e) {
                    var style = window.getComputedStyle(element);
                    if (/max-window/.test(element.className)) {
                        return;
                    }
                    if (e.clientX < (parseInt(style.left) || 0) + (parseInt(style.width) || 0) - 15 ||
                        e.clientY < (parseInt(style.top) || 0) + (parseInt(style.height) || 0) - 15) {
                        mousedown(e);
                    }
                });
                window.addEventListener('mouseup', function () {
                    temp.e = null;
                    element.style.cursor = 'default';
                    window.removeEventListener('mousemove', mousemove);
                });
                function mousedown(e) {
                    var style = window.getComputedStyle(element);
                    temp.e = e;
                    temp.x = e.clientX - (parseInt(style.left) || 0);
                    temp.y = e.clientY - (parseInt(style.top) || 0);
                    element.style.cursor = 'move';
                    window.addEventListener('mousemove', mousemove);
                }
                function mousemove(e) {
                    element.style.left = e.clientX - temp.x + 'px';
                    element.style.top = e.clientY - temp.y + 'px';
                }
            }
        }
    </script>
</body>

</html>